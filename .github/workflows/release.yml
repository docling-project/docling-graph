name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  id-token: write

jobs:
  test-build:
    name: Test build and publish to TestPyPI
    runs-on: ubuntu-latest
    environment:
      name: testpypi
      url: https://test.pypi.org/p/docling-graph
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
      
      - name: Install uv
        uses: astral-sh/setup-uv@v7
      
      - name: Build package
        run: uv build
      
      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          skip-existing: true
          attestations: false
      
      - name: Verify package on TestPyPI
        run: |
          # Strip 'v' prefix from tag name to get actual version
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          
          echo "- Package docling-graph ${VERSION} published to TestPyPI"
          echo "View at: https://test.pypi.org/project/docling-graph/${VERSION}/"
          echo ""
          echo "Note: TestPyPI installation test skipped due to unreliable dependency resolution."
          echo "Full installation will be verified after PyPI publication."
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: dist
          path: dist/
  
  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: test-build
    environment:
      name: pypi
      url: https://pypi.org/p/docling-graph
    
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v7
        with:
          name: dist
          path: dist/
      
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
      
      - name: Upload artifacts to GitHub Release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          # Semantic-release already created the GitHub release
          # Just upload the distribution files to it (excluding .attestation files)
          # Attestation files are kept on PyPI but filtered from GitHub releases for cleaner presentation
          find dist/ -type f ! -name '*.attestation' -exec gh release upload '${{ github.ref_name }}' {} --repo '${{ github.repository }}' --clobber +
      
      - name: Summary
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION_NUM="${VERSION#v}"
          
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Release **${VERSION}** published successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published to:" >> $GITHUB_STEP_SUMMARY
          echo "- [TestPyPI](https://test.pypi.org/project/docling-graph/${VERSION_NUM}/)" >> $GITHUB_STEP_SUMMARY
          echo "- [PyPI](https://pypi.org/project/docling-graph/${VERSION_NUM}/)" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${VERSION})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Install:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "pip install docling-graph==${VERSION_NUM}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
