<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Graph Visualization - Cytoscape</title>

    <!-- Cytoscape core -->
    <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>

    <!-- Dagre layout extension (optional but more reliable) -->
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background: #17191d;
            color: #ffffff;
            overflow: hidden;
            height: 100vh;
        }

        #cy {
            width: 100%;
            height: 100vh;
            background: #343b46; /* --cosmos-background */
            box-shadow: inset 0 0 100px rgba(0, 0, 0, 0.5);
        }

        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(34, 35, 37, 0.95); /* --sidebar-background */
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            z-index: 1000;
            min-width: 200px;
            color: #ffffff;
        }

        /* Combined rule for both titles */
        .controls h3, .stats h3 {
            margin: 0 0 12px 0;
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
            border-bottom: 2px solid #76b7b2; /* Palette color */
            padding-bottom: 8px;
        }

        .control-group {
            margin: 10px 0;
        }

        .control-group label {
            display: block;
            font-size: 13px;
            color: #e2e8f0;
            margin-bottom: 6px;
            font-weight: 500;
        }

        select, button {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #4a5568;
            border-radius: 6px;
            font-size: 13px;
            background: #2f3032; /* --table-background */
            color: #ffffff;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        select:hover, select:focus {
            border-color: #76b7b2;
            outline: none;
        }

        .control-group button {
            background: #76b7b2;
            color: #17191d;
            border: none;
            font-weight: 600;
            margin-top: 5px;
        }

        .control-group button:hover {
            box-shadow: 0 4px 12px rgba(118, 183, 178, 0.3);
        }

        .control-group button:active {
            transform: translateY(0);
        }

        .info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(34, 35, 37, 0.95); /* --sidebar-background */
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            z-index: 1000;
            min-width: 250px;
            max-width: 400px;
            display: none;
            max-height: 60vh;
            overflow-y: auto;
            color: #ffffff;
        }

        .info-panel.active {
            display: block;
        }

        .info-item {
            margin: 6px 0;
            font-size: 13px;
            color: #e2e8f0;
            word-wrap: break-word;
        }

        .info-label {
            font-weight: 600;
            color: #76b7b2; /* Palette color */
        }

        .stats {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(34, 35, 37, 0.95); /* --sidebar-background */
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            z-index: 1000;
            font-size: 13px;
            color: #ffffff;
            max-width: 300px;
        }

        .stats strong {
            color: #76b7b2; /* Palette color */
        }

        
        .stats .info-label {
            margin-bottom: 4px;
        }

        .info-count {
            font-size: 12px;
            color: #e2e8f0;
        }

        .node-types {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #4a5568;
            color: #76b7b2;
        }

        .node-types-title {
            color: #76b7b2;
            margin-bottom: 8px;
        }

        .node-type-item {
            margin-left: 10px;
            font-size: 12px;
            color: #e2e8f0;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(34, 35, 37, 0.95);
            padding: 30px 50px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            font-size: 18px;
            color: #ffffff;
            z-index: 2000;
            display: none;
        }

        .loading.active {
            display: block;
        }
    </style>
</head>
<body>
    <div id="cy"></div>

    <div class="loading" id="loading">
        <div>‚è≥ Loading Graph...</div>
    </div>

    <div class="stats">
        <!-- Title for the stats panel -->
        <h3>ü™ß Information</h3>
        <div class="summary">
            <div class="info-label"><strong>Nodes:</strong> <span class="info-count" id="node-count">0</span></div>
            <div class="info-label"><strong>Edges:</strong> <span class="info-count" id="edge-count">0</span></div>
        </div>
        <div class="node-types">
            <div class="node-types-title"><strong>Node types:</strong></div>
            <div id="node-types-list"></div>
        </div>
    </div>

    <div class="info-panel" id="info-panel">
        <div id="info-content"></div>
    </div>

    <div class="controls">
        <h3>‚öôÔ∏è Controls</h3>

        <div class="control-group">
            <label for="layout-select">Layout Algorithm</label>
            <select id="layout-select">
                <option value="dagre">Hierarchical (Dagre)</option>
                <option value="cose">Force-directed (CoSE)</option>
                <option value="circle">Circle</option>
                <option value="grid">Grid</option>
                <option value="breadthfirst">Breadth-first</option>
                <option value="concentric">Concentric</option>
            </select>
        </div>

        <div class="control-group">
            <button id="reset-btn">Reset View</button>
        </div>
    </div>

    <script>
        const graphElements = {
  "nodes": [
    {
      "data": {
        "id": "Address_470628575eee4fec",
        "label": "Address",
        "type": "entity",
        "__class__": "Address",
        "street": "Rue du Lac 1268",
        "postal_code": "2501",
        "city": "Biel"
      }
    },
    {
      "data": {
        "id": "Issuer_e519693c8a8c7295",
        "label": "Issuer",
        "type": "entity",
        "__class__": "Issuer",
        "name": "Robert Schneider AG",
        "phone": "059/987 6540",
        "email": "robert@rschneider.ch",
        "website": "www.rschneider.ch"
      }
    },
    {
      "data": {
        "id": "Address_ccb46e76cabd2931",
        "label": "Address",
        "type": "entity",
        "__class__": "Address",
        "street": "Marktgasse 28",
        "postal_code": "9400",
        "city": "Rorschach"
      }
    },
    {
      "data": {
        "id": "Client_e6998cd84d020d7a",
        "label": "Client",
        "type": "entity",
        "__class__": "Client",
        "name": "Ms Pia Rutschmann"
      }
    },
    {
      "data": {
        "id": "LineItem_8f9869d4897d82dd",
        "label": "LineItem",
        "type": "entity",
        "__class__": "LineItem",
        "description": "Garden work",
        "quantity": 28.0,
        "unit": "Std.",
        "unit_price": 120.0,
        "total": 3360.0
      }
    },
    {
      "data": {
        "id": "LineItem_f40d665171e08acf",
        "label": "LineItem",
        "type": "entity",
        "__class__": "LineItem",
        "description": "Disposal of cuttings",
        "quantity": 1.0,
        "unit_price": 307.35,
        "total": 307.35
      }
    },
    {
      "data": {
        "id": "Invoice_ee6ad218c42b3847",
        "label": "Invoice",
        "type": "entity",
        "__class__": "Invoice",
        "total": 3949.75,
        "bill_no": "3139",
        "date": "01.07.2020",
        "currency": "CHF",
        "subtotal": 3667.35,
        "vat_rate": 7.7,
        "vat_amount": 282.4
      }
    }
  ],
  "edges": [
    {
      "data": {
        "source": "Issuer_e519693c8a8c7295",
        "target": "Address_470628575eee4fec",
        "label": "LOCATED_AT",
        "id": "Issuer_e519693c8a8c7295-Address_470628575eee4fec-0"
      }
    },
    {
      "data": {
        "source": "Client_e6998cd84d020d7a",
        "target": "Address_ccb46e76cabd2931",
        "label": "LIVES_AT",
        "id": "Client_e6998cd84d020d7a-Address_ccb46e76cabd2931-1"
      }
    },
    {
      "data": {
        "source": "Invoice_ee6ad218c42b3847",
        "target": "Issuer_e519693c8a8c7295",
        "label": "ISSUED_BY",
        "id": "Invoice_ee6ad218c42b3847-Issuer_e519693c8a8c7295-2"
      }
    },
    {
      "data": {
        "source": "Invoice_ee6ad218c42b3847",
        "target": "Client_e6998cd84d020d7a",
        "label": "SENT_TO",
        "id": "Invoice_ee6ad218c42b3847-Client_e6998cd84d020d7a-3"
      }
    },
    {
      "data": {
        "source": "Invoice_ee6ad218c42b3847",
        "target": "LineItem_8f9869d4897d82dd",
        "label": "CONTAINS_ITEM",
        "id": "Invoice_ee6ad218c42b3847-LineItem_8f9869d4897d82dd-4"
      }
    },
    {
      "data": {
        "source": "Invoice_ee6ad218c42b3847",
        "target": "LineItem_f40d665171e08acf",
        "label": "CONTAINS_ITEM",
        "id": "Invoice_ee6ad218c42b3847-LineItem_f40d665171e08acf-5"
      }
    }
  ],
  "meta": {
    "node_types": {
      "Address": 2,
      "Issuer": 1,
      "Client": 1,
      "LineItem": 2,
      "Invoice": 1
    },
    "node_count": 7,
    "edge_count": 6
  }
};
        // The Python script will replace the placeholder line above with:
        // const graphElements = { ... your data ... };
        
        // Fallback for standalone preview (if placeholder isn't replaced)
        if (typeof graphElements === 'undefined') {
          console.warn("graphElements not injected by Python. Using sample data.");
          // Use window scope to make it available globally like the injected const
          window.graphElements = {
              "nodes": [
                  { "data": { "id": "n1", "label": "Person", "name": "Alice" } },
                  { "data": { "id": "n2", "label": "Person", "name": "Bob" } },
                  { "data": { "id": "n3", "label": "Company", "name": "Innovate Inc." } }
              ],
              "edges": [
                  { "data": { "id": "e1", "source": "n1", "target": "n2", "label": "KNOWS" } },
                  { "data": { "id": "e2", "source": "n1", "target": "n3", "label": "WORKS_AT" } },
                  { "data": { "id": "e3", "source": "n2", "target": "n3", "label": "WORKS_AT" } }
              ],
              "meta": {
                  "node_types": { "Person": 2, "Company": 1 },
                  "node_count": 3,
                  "edge_count": 3
              }
          };
        }
        /* END ELEMENTS_DATA_PLACEHOLDER */


        /* Generate color per node label */
        const NODE_COLOR_PALETTE = [
            '#4e79a7', '#f28e2c', '#e15759', '#76b7b2', '#59a14f', 
            '#edc949', '#af7aa1', '#ff9da7', '#9c755f', '#bab0ab'
        ];
        const labelColorMap = new Map();
        let colorIndex = 0;

        function stringToColor(str) {
          const key = String(str);
          if (labelColorMap.has(key)) {
            return labelColorMap.get(key);
          }

          // Assign the next color from the palette
          const color = NODE_COLOR_PALETTE[colorIndex % NODE_COLOR_PALETTE.length];
          labelColorMap.set(key, color);
          colorIndex++;
          return color;
        }

        /* Count by label, with fallbacks */
        function calculateNodeTypeStats(elements) {
          const counts = {};
          (elements.nodes || []).forEach(node => {
            const d = node.data || {};
            let labels = [];
            if (Array.isArray(d.labels)) {
              labels = d.labels.map(String).filter(Boolean);
            } else if (typeof d.labels === 'string') {
              const parts = d.labels.split(/[|,]/).map(s => s.trim()).filter(Boolean);
              if (parts.length) labels = parts;
              else if (d.labels.includes(':') && !d.labels.trim().startsWith('http')) {
                labels = d.labels.split(':').filter(Boolean);
              } else {
                labels = [d.labels];
              }
            }
            if (labels.length) {
              labels.forEach(l => { counts[l] = (counts[l] || 0) + 1; });
              return;
            }
            const key = d.label || d.node_label || d.node_type || d.type || d.category || d.class || d.kind || 'Unknown';
            counts[key] = (counts[key] || 0) + 1;
          });
          return counts;
        }

        // Display node type statistics
        function displayNodeTypeStats(nodeTypes) {
            const nodeTypesList = document.getElementById('node-types-list');
            const sortedTypes = Object.entries(nodeTypes).sort((a, b) => b[1] - a[1]);

            nodeTypesList.innerHTML = sortedTypes.map(([type, count]) => {
                // Use the 'Unknown' key for the default color if type is null/undefined
                const colorKey = type === 'null' || type === 'undefined' ? 'Unknown' : type;
                const color = stringToColor(String(colorKey));
                
                // This is the part that creates the colored circle legend
                return `<div class="node-type-item" style="display: flex; align-items: center; margin-bottom: 4px;">
                            <span style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; flex-shrink: 0;"></span>
                            <span>${type} - ${count}</span>
                        </div>`;
            }).join('');
        }

        // Initialize Cytoscape
        const cy = cytoscape({
            container: document.getElementById('cy'),
            elements: graphElements,
            style: [
                {
                    selector: 'node',
                    style: {
                        // --- Node Body Styling ---
                        'background-color': function(ele) {
                          const key = ele.data('label') || ele.data('type') || 'Unknown';
                          return stringToColor(String(key));
                        },
                        'width': 60,
                        'height': 60,
                        'border-width': 0, // No border by default
                        'border-color': 'rgba(255,255,255,0.7)',
                        
                        // --- Label Styling ---                        
                        'label': 'data(label)',
                        'color': function(ele) {
                          const key = ele.data('label') || ele.data('type') || 'Unknown';
                          return stringToColor(String(key));
                        },
                        'text-valign': 'top',
                        'text-halign': 'center',
                        'text-margin-y': -12, // Move label up a bit more to clear the node
                        'font-size': '10px',
                        'font-weight': 'bold',

                        // --- Label Background Box ---
                        'text-background-color': '#1e2428',
                        'text-background-shape': 'round-rectangle', // Rounded edges
                        'text-background-padding': '4px', // Padding inside the box
                        'text-background-opacity': 0.75, // Make background solid
                    }
                },
                {
                    selector: 'node:selected',
                    style: {
                        'border-width': 6, // Larger border width
                        'border-color': 'white', // White border
                        'border-style': 'double' // Creates "padding" effect
                    }
                },
                {
                    selector: 'node:active',
                    style: {
                        'overlay-opacity': 0
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'width': 1, // Thinner line
                        'line-color': 'rgba(255, 255, 255, 0.2)', // Muted color
                        'target-arrow-shape': 'none', // No arrows
                        'curve-style': 'bezier',
                        'opacity': 0.6,
                        'transition-property': 'line-color, width, opacity',
                        'transition-duration': '0.3s'
                        // --- Edge Label Styling (REMOVED) ---
                    }
                },
                {
                    selector: 'edge:selected',
                    style: {
                        'line-color': '#76b7b2',
                        'width': 3,
                        'opacity': 1
                    }
                },
                // Highlighted elements (when node is clicked)
                {
                    selector: '.highlighted',
                    style: {
                        'opacity': 1,
                        'z-index': 997
                    }
                },
                // Faded elements (when highlighting)
                {
                    selector: '.faded',
                    style: {
                        'opacity': 0.15
                    }
                }
            ],
            layout: {
                name: 'dagre',
                rankDir: 'TB',
                nodeSep: 50,
                rankSep: 100,
                padding: 30
            },
            minZoom: 0.1,
            maxZoom: 3,
            wheelSensitivity: 0.2
        });

        // Add cursor pointer style to canvas when hovering nodes
        cy.on('mouseover', 'node', function(evt) {
            document.getElementById('cy').style.cursor = 'pointer';
        });

        cy.on('mouseout', 'node', function(evt) {
            document.getElementById('cy').style.cursor = 'default';
        });

        // Add cursor pointer style to canvas when hovering edges
        cy.on('mouseover', 'edge', function(evt) {
            document.getElementById('cy').style.cursor = 'pointer';
        });

        cy.on('mouseout', 'edge', function(evt) {
            document.getElementById('cy').style.cursor = 'default';
        });

        /* Update stats */
        const meta = graphElements.meta || {};
        document.getElementById('node-count').textContent = (meta.node_count != null) ? meta.node_count : cy.nodes().length;
        document.getElementById('edge-count').textContent = (meta.edge_count != null) ? meta.edge_count : cy.edges().length;

        /* Prefer Python-provided meta, fallback to client-side calc */
        const nodeTypeStats = (meta.node_types && Object.keys(meta.node_types).length)
          ? meta.node_types
          : calculateNodeTypeStats(graphElements);

        displayNodeTypeStats(nodeTypeStats);

        // Hide loading
        document.getElementById('loading').classList.remove('active');

        // Layout selector
        document.getElementById('layout-select').addEventListener('change', function(e) {
            const layoutName = e.target.value;
            let layoutOptions = { name: layoutName };

            if (layoutName === 'dagre') {
                layoutOptions = {
                    name: 'dagre',
                    rankDir: 'TB',
                    nodeSep: 50,
                    rankSep: 100,
                    padding: 30
                };
            } else if (layoutName === 'cose') {
                layoutOptions = {
                    name: 'cose',
                    animate: true,
                    animationDuration: 1000,
                    nodeRepulsion: 8000,
                    idealEdgeLength: 100,
                    edgeElasticity: 100,
                    nestingFactor: 5,
                    gravity: 80,
                    numIter: 1000,
                    padding: 30
                };
            } else if (layoutName === 'breadthfirst') {
                layoutOptions = {
                    name: 'breadthfirst',
                    directed: true,
                    spacingFactor: 1.5,
                    padding: 30
                };
            } else {
                layoutOptions = {
                    name: layoutName,
                    padding: 30
                };
            }

            cy.layout(layoutOptions).run();
        });

        // Reset view button
        document.getElementById('reset-btn').addEventListener('click', function() {
            cy.fit(undefined, 20);
            cy.center();
        });

        // Node click handler - show details and highlight
        cy.on('tap', 'node', function(evt) {
            const node = evt.target;
            const data = node.data();

            // Highlight neighbors
            cy.elements().removeClass('highlighted faded');
            const neighborhood = node.neighborhood().add(node);
            cy.elements().addClass('faded');
            neighborhood.removeClass('faded').addClass('highlighted');

            // Show info panel
            const infoPanel = document.getElementById('info-panel');
            const infoContent = document.getElementById('info-content');

            let html = '<div style="margin-bottom: 8px; font-weight: 600; color: #e2e8f0;">üìç Node Details</div>';
            for (const [key, value] of Object.entries(data)) {
                if (value != null && value !== '') {
                    const displayValue = String(value).length > 100 
                        ? String(value).substring(0, 100) + '...' 
                        : value;
                    html += `<div class="info-item"><span class="info-label">${key}:</span> ${displayValue}</div>`;
                }
            }

            infoContent.innerHTML = html;
            infoPanel.classList.add('active');
        });

        // Edge click handler - show details and highlight
        cy.on('tap', 'edge', function(evt) {
            const edge = evt.target;
            const data = edge.data();

            cy.elements().removeClass('highlighted faded');
            cy.elements().addClass('faded');

            edge.removeClass('faded').addClass('highlighted');
            edge.source().removeClass('faded').addClass('highlighted');
            edge.target().removeClass('faded').addClass('highlighted');

            // Show edge info
            const infoPanel = document.getElementById('info-panel');
            const infoContent = document.getElementById('info-content');

            let html = '<div style="margin-bottom: 8px; font-weight: 600; color: #e2e8f0;">üîó Edge Details</div>';
            html += `<div class="info-item"><span class="info-label">From:</span> ${data.source}</div>`;
            html += `<div class="info-item"><span class="info-label">To:</span> ${data.target}</div>`;

            for (const [key, value] of Object.entries(data)) {
                if (value != null && value !== '' && key !== 'source' && key !== 'target' && key !== 'id') {
                    const displayValue = String(value).length > 100 
                        ? String(value).substring(0, 100) + '...' 
                        : value;
                    html += `<div class="info-item"><span class="info-label">${key}:</span> ${displayValue}</div>`;
                }
            }

            infoContent.innerHTML = html;
            infoPanel.classList.add('active');
        });

        // Click on background - clear highlights
        cy.on('tap', function(evt) {
            if (evt.target === cy) {
                cy.elements().removeClass('highlighted faded');
                document.getElementById('info-panel').classList.remove('active');
            }
        });

        // Fit graph to view on load
        cy.ready(function() {
            cy.fit(undefined, 20);
            cy.center();
        });
    </script>
</body>
</html>

